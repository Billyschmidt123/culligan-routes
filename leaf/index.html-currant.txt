<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Culligan Bottled Water- Grande Prairie</title>

<!-- LOCAL LEAFLET -->
<link rel="stylesheet" href="leaflet/leaflet.css" />
<script src="leaflet/leaflet.js"></script>

<style>
  :root { --culligan-blue: #002b7f; --accent-blue: #0078ff; }
  body { margin: 0; height: 100vh; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; background: #1a1a1a; color: white; overflow: hidden; }
  #topbar { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; background: #222; border-bottom: 2px solid var(--accent-blue); z-index: 1001; }
  #activeDeliveryDisplay { flex: 1; text-align: center; margin: 0 20px; color: #fff; font-size: 14px; display: none; }
  #activeDeliveryDisplay b { color: var(--accent-blue); }
  #topPhoneLink { color: #28a745; text-decoration: none; font-weight: bold; }
  #loadingContainer { width: 100%; height: 5px; background: #111; display: none; }
  #loadingBar { width: 0%; height: 100%; background: var(--accent-blue); transition: width 0.3s; }
  #mainContainer { display: flex; flex: 1; overflow: hidden; }
  #sidebar { width: 380px; background: #222; border-right: 1px solid #444; display: flex; flex-direction: column; }
  #sidebarFixed { padding: 15px; border-bottom: 1px solid #444; flex-shrink: 0; }
  #sidebarScroll { flex: 1; overflow-y: auto; padding: 10px 15px; }
  #map { flex: 1; height: 100%; background: #111; z-index: 1; }
  .btn { padding: 10px 15px; background: var(--accent-blue); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 5px; }
  .btn-green { background: #28a745; }
  .btn-red { background: #dc3545; }
  .btn-orange { background: #f39c12; }
  .card-input { width: 100%; padding: 8px; margin: 4px 0; border-radius: 4px; border: 1px solid #555; background: #111; color: white; box-sizing: border-box; font-size: 13px; }
  #activeStopCard { display:none; background:#2a2a2a; padding:12px; border-radius:8px; border-left:5px solid #28a745; display: flex; flex-direction: column; }
  #stopCardInner { overflow-y: auto; margin-top: 8px; border-top: 1px solid #444; padding-top: 8px; }
  #managerOverlay, #syncModal, #settingsOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; align-items:center; justify-content:center; }
  .mgr-content { width: 95%; max-width: 850px; background: #222; border-radius: 10px; padding: 20px; border: 1px solid #444; overflow-y: auto; max-height: 90vh; }
  .map-label { background: var(--accent-blue); border: 2px solid white; border-radius: 50%; color: white; font-weight: bold; text-align: center; line-height: 20px; width: 20px; height: 20px; font-size: 12px; }
  .map-label-active { background: #dc3545; border: 2px solid white; border-radius: 50%; color: white; font-weight: bold; text-align: center; line-height: 24px; width: 24px; height: 24px; font-size: 14px; z-index: 1000 !important; }
  .report-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  .report-table th, .report-table td { border: 1px solid #444; padding: 8px; text-align: left; }
  .report-table th { background: #333; color: var(--accent-blue); }
</style>
</head>
<body>

<!-- UI OMITTED FOR BREVITY — SAME AS YOUR CURRENT VERSION -->

<script>
/* Tell Leaflet where your marker icons live */
L.Icon.Default.imagePath = 'leaflet/images/';

let map, stops = [], currentStopIndex = 0, allFiles = [], markerLayer, routeLine, stopMarkers = [], signaturePad, liveTripReport = [];
const warehouse = { lat: 55.1707, lng: -118.7947 };
let slipSequence = 45;

window.onload = async () => {
    map = L.map("map").setView([warehouse.lat, warehouse.lng], 11);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    markerLayer = L.layerGroup().addTo(map);
    routeLine = L.polyline([], {color: '#0078ff', weight: 5}).addTo(map);

    try {
        const res = await fetch('./Routes/list_files.php');
        allFiles = await res.json();
        document.getElementById('serverFileSelect').innerHTML =
            allFiles.map(f => `<option value="${f}">${f}</option>`).join('');
    } catch(e) {}

    const canvas = document.getElementById('signature-pad');
    if(canvas) signaturePad = new SignaturePad(canvas);
};

function getDist(p1, p2) {
    return Math.sqrt(Math.pow(p1.lat - p2.lat, 2) + Math.pow(p1.lng - p2.lng, 2));
}

/* Your original working nearest-neighbor */
function optimizeCircular(rawStops) {
    let unvisited = [...rawStops];
    let optimized = [];
    let currentPos = warehouse;
    while (unvisited.length > 0) {
        unvisited.sort((a, b) => getDist(currentPos, a) - getDist(currentPos, b));
        let closest = unvisited.shift();
        optimized.push(closest);
        currentPos = closest;
    }
    return optimized;
}

async function confirmSyncUpdate() {
    const file = document.getElementById('serverFileSelect').value;
    document.getElementById('syncModal').style.display = 'none';

    try {
        const res = await fetch(`./Routes/${file}`);
        const buffer = await res.arrayBuffer();
        const workbook = XLSX.read(new Uint8Array(buffer), {type: 'array'});
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

        let rawStops = rows.map(r => ({
            company: r.Company || r.Customer || "Unnamed",
            address: r.Address || "No Address",
            phone: r.Phone || "No Phone",
            email: r.Email || "",
            lat: r.Latitude || warehouse.lat,
            lng: r.Longitude || warehouse.lng
        }));

        stops = optimizeCircular(rawStops);
        renderRoute();

        currentStopIndex = 0;
        updateActiveCard();
        document.getElementById("setupSection").style.display = "none";
        document.getElementById("activeStopCard").style.display = "flex";

    } catch (e) {
        alert("Load Failed");
    }
}

function renderRoute() {
    markerLayer.clearLayers();
    stopMarkers = [];

    const pathCoords = [[warehouse.lat, warehouse.lng]];

    document.getElementById("stopList").innerHTML = stops.map((s, i) => {
        const marker = L.marker([s.lat, s.lng], {
            icon: L.divIcon({
                className: 'map-label',
                html: i + 1,
                iconSize: [20, 20]
            })
        }).addTo(markerLayer);

        marker.bindTooltip(`<b>${s.company}</b><br>${s.address}<br>${s.phone}`);

        stopMarkers.push(marker);
        pathCoords.push([s.lat, s.lng]);

        return `<div style="padding:8px; border-bottom:1px solid #444; background:#2a2a2a; font-size:12px;">
                    ${i + 1}. ${s.company}
                </div>`;
    }).join('');

    pathCoords.push([warehouse.lat, warehouse.lng]);
    routeLine.setLatLngs(pathCoords);

    if (pathCoords.length > 0) {
        map.fitBounds(routeLine.getBounds());
    }
}

/* Rest of your JS unchanged — updateActiveCard, processNext, etc. */

</script>
</body>
</html>